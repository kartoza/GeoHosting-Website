<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Products</title>
    <link rel="stylesheet" href="../styles.css"> 
    <link rel="stylesheet" href="product_tabs.css">
</head>

<body>
    
    {% include "templates/navbar.html" %}

    {% block content %}
    <div class="background-container" id="screenBody">
        <!-- Left background image -->
        <div class="background-left"></div>
        <!-- Right background image -->
        <div class="background-right"></div>
        <script>
            function trimDescription(description) {
                const maxCharacters = 280; // Maximum number of characters
                if (description.length > maxCharacters) {
                    // Trim the description and append '...'
                    return description.substring(0, maxCharacters - 3) + '...</p></div>';
                } else {
                    return description;
                }
            }
            </script>
        <!-- Content -->
        <div class="content">
            <div class="">
                <img src="/assets/geohosting/images/GeoH1.png"  alt="Logo" class="geohosting-logo">
                
                  <div class="geohosting-heading">Welcome to a better GIS platform where privacy and freedom comes first.</div>
                
                 <div class="products-container">

                    {% for item in stock_items %}

                    <div class="product">
                        <div>
                            <img src="{{ item.image }}" alt="Product">
                        </div>
                      
                        <h2>{{ item.item_name }}</h2>
                        <div class="description">
                            <p><script>document.write(trimDescription('{{ item.description }}'));</script></p>
                        </div>
                        <button class="learn-more-button" onclick="toggleProductDetails('{{ item.item_name }}','{{ item.image }}')">Learn more</button>
                        <div></div>
                
                    </div>

                    {% endfor %}

                </div>

            </div>
        </div>

        <div id="hiddenSection" style="display: none;">

            

            <!-- Navbar -->
            <div class="secondary-navigation-bar" id="navbar">
                <div class="secondary-logo">
                <img src="" id="navbar-logo" alt="Logo">
                </div>
                <ul>
                <li><a href="#" id="overview-link" class="active" onclick="loadContentAndSetActiveTab(event, 'product_overview.html', 'overview-content', this)">Overview</a></li>
                <li><a href="#" id="integration-link" onclick="loadContentAndSetActiveTab(event, 'product_integration.html', 'integration-content', this)">Integration</a></li>
                <li><a href="#" id="pricing-link" onclick="loadContentAndSetActiveTab(event, 'product_pricing.html', 'pricing-content', this)">Pricing</a></li>
                </ul>
            </div>
            
            <div id="loading-indicator" style="display: none;">
                <div class="loader"></div>
            </div>
            <div id="hiddenSectionContent" style="display: none;">
                <div id="overview-content" style="display: none;"></div>
                <div id="integration-content" style="display: none;"></div>
                <div id="pricing-content" style="display: none;"></div>
            </div>

            

        </div>
           
        <button id="scrollToTopBtn" onclick="scrollToTop()">&#8593;</button>

            
            <script>

                // add a scroll button for easy nav
                window.onscroll = function() {scrollFunction()};

                function scrollFunction() {
                    if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
                        document.getElementById("scrollToTopBtn").style.display = "block";
                    } else {
                        document.getElementById("scrollToTopBtn").style.display = "none";
                    }
                }

                function scrollToTop() {
                    document.body.scrollTop = 0; // For Safari
                    document.documentElement.scrollTop = 0; // For Chrome, Firefox, IE and Opera
                }

                // make scrolling smoother
                function smoothScrollTo(element, duration) {
                    const targetPosition = element.offsetTop;
                    const startPosition = window.pageYOffset;
                    const distance = targetPosition - startPosition;
                    let startTime = null;

                    function animation(currentTime) {
                        if (startTime === null) startTime = currentTime;
                        const timeElapsed = currentTime - startTime;
                        const scrollProgress = Math.min(timeElapsed / duration, 1);
                        window.scrollTo(0, startPosition + distance * ease(scrollProgress));

                        if (timeElapsed < duration) requestAnimationFrame(animation);
                    }

                    function ease(t) {
                        return t < 0.5 ? 2 * t * t : -1 + (4 - 2 * t) * t;
                    }

                    requestAnimationFrame(animation);
                }

                var loadingIndicator = document.getElementById('loading-indicator');
                var hiddenSectionContent =  document.getElementById('hiddenSectionContent');

                function toggleProductDetails(item_name, logoUrl) {
                    var stockItems = JSON.parse('{{ stock_items | tojson | safe }}');
                    // console.log(stockItems); // testing purposes

                    localStorage.setItem('logoUrl', JSON.stringify(logoUrl));
                    var hiddenSection = document.getElementById('hiddenSection');

                    if (hiddenSection.style.display === 'none') {
                        hiddenSection.style.display = 'block';
                        loadingIndicator.style.display = 'block';
                        
                        smoothScrollTo(hiddenSection, 1000); 
                        loadContentAndSetActiveTab(event, 'product_overview.html', 'overview-content', document.getElementById('overview-link'), logoUrl)

                        setTimeout(() => {
                            hiddenSectionContent.style.display = 'block';
                            loadingIndicator.style.display = 'none';
                        }, 1200);
                    } else {
                        hiddenSection.style.display = 'none';
                    }
                    document.getElementById('navbar-logo').src = logoUrl;

                    var buttons = document.querySelectorAll('.learn-more-button');
                    var currentButton = event.currentTarget;
                    var isExpanded = hiddenSection.style.display !== 'none';

                    buttons.forEach(function(button) {
                        if (button === currentButton) {
                            button.textContent = isExpanded ? 'Close' : 'Learn more';
                            button.style.marginLeft = isExpanded ? '5%' : '';
                        } else {
                            if (isExpanded) {
                                button.classList.add('disabled');
                                button.style.opacity = '0.7';
                                button.disabled = true;
                            } else {
                                button.classList.remove('disabled');
                                button.style.opacity = '1';
                                button.disabled = false;
                            }
                        }
                    });
                }




            
                // Function to load content and set active tab
                function loadContentAndSetActiveTab(event, url, targetId, clickedLink, logoUrl) {
                    hiddenSectionContent.style.display = 'none';
                    loadingIndicator.style.display = 'block';
                    event.preventDefault(); // Prevent default anchor behavior
                    var xhr = new XMLHttpRequest();
                    xhr.onreadystatechange = function() {
                        if (xhr.readyState === XMLHttpRequest.DONE) {
                            if (xhr.status === 200) {
                                hiddenSectionContent.style.display = 'block';
                                loadingIndicator.style.display = 'none';
                                var targetElement = document.getElementById(targetId);
                                // Hide content of the previously active tab
                                document.querySelectorAll('#hiddenSectionContent > div').forEach(function(content) {
                                    if (content !== targetElement) {
                                        content.style.display = 'none';
                                    }
                                });
                                targetElement.innerHTML = xhr.responseText;
                                // Make the loaded content visible
                                targetElement.style.display = 'block';
                                // Remove active class from all links
                                document.querySelectorAll('.secondary-navigation-bar ul li a').forEach(function(link) {
                                    link.classList.remove('active');
                                });
                                // Add active class to the clicked link
                                clickedLink.classList.add('active');

                                // fetch id from local storage iterate stock items in context and find a match retrieve values to assign pricing cards TODO

                                document.getElementById('pricing-card-logo').src = JSON.parse(localStorage.getItem('logoUrl'));
                                document.getElementById('pricing-card-title-free').innerHTML = 'GeoSight Free'
                            } else {
                                console.error('Error loading content:', xhr.status);
                            }
                        }
                    };
                    xhr.open('GET', url, true);
                    xhr.send();
                }
            </script>

        
  
    
    {% endblock %}

    {% include "templates/footer.html" %}
</body>

</html>